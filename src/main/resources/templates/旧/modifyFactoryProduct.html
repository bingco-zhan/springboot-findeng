<!-- 厂家修改商品 -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>厂家修改商品</title>
</head>
<style>
    .must {
        margin-right: 3px;
        color: red;
        font-size: 15px;
        font-weight: bold;
    }

    .input-group-addon {
        background-color: #fff;
        font-size: 13px;
    }

    .typeList > div {
        margin-top: 7px;
    }

    .typeList .input-group, .typeList .input-group button, .typeList .input-group .btn-group {
        width: 100%;
    }

    .row {
        margin-top: 18px;
    }

    .title-tag {
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 400;
        border-radius: 4px;
        color: #555;
        margin-top: 3px;
        height: 34px;
    }

    .subtitle-tag {
        font-weight: 400;
        line-height: 1;
        color: #555;
        margin-top: 5px;
        font-size: 12px;
    }

    .glyphicon-plus {
        color: green;
    }

    .upload_button {
        position: absolute;
        width: 40%;
        height: 20%;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 30px;
        right: 0;
        border: 1px solid #ddd;
        border-radius: 3px;
        background-color: #fff;
        color: #555;
    }

    .btn-lg {
        margin-top: 10px
    }

    .imgcontent {
        margin-top: 5px;
    }

    .imgcontent .thumbnail {
        height: 180px;
    }

    .imgcontent .thumbnail img {
        width: 100%;
        height: 100%
    }

    .prompt_text {
        position: absolute;
        text-align: center;
        width: 85%;
        top: 20%;
        color: red;
    }

    .prompt_text1 {
        position: absolute;
        text-align: center;
        width: 85%;
        top: 20%;
        color: #000;
    }

    .input-group-addon input[type="checkbox"] {
        display: none
    }

    .typeList .input-group-addon {
        width: 89px;
    }

    .input-group-addon.addonColor i {
        color: green
    }

    .input-group-addon.addonColor {
        border: 1px solid #5FB878
    }

    .material {
        margin-top: 10px;
    }

    .space {
        margin-top: 10px;
    }

    .material span {
        padding: 0 10px
    }

    .material span i {
        font-size: 16px;
    }

    .LightDistribution {
        width: 18px;
        height: 18px;
    }

    .goodsOfType {
        width: 18px;
        height: 18px;
    }

    .bs-searchbox {
        margin-bottom: 40px
    }

    .form-group .bootstrap-select.btn-group {
        width: 220px
    }

    .jconfirm .jconfirm-box div.jconfirm-content-pane .jconfirm-content img {
        height: 97%;
    }

    .glyphicon-remove {
        float: right;
    }
</style>
<body>
<div class="container-fluid" id="formName">
    <div class="row">
        <div class="col-md-3">
            <div class="input-group" style="margin-top:7px;">
                <span class="input-group-addon"><i class="must">*</i>商品型号</span>
                <input type="text" class="form-control productCode" placeholder="请输入商品型号"
                       aria-describedby="basic-addon1">
            </div>
        </div>
        <div class="col-md-3 form-group">
            <div class="input-group" style="margin-top:7px;">
                <span class="input-group-addon"><i class="must">*</i>产品系列</span>
                <select id="series" class="series form-control" data-live-search="true"></select>
            </div>
        </div>
        <div class="col-md-3" style="margin-top:7px;">
            <div class="input-group">
                <span class="input-group-addon"><i class="must">*</i>货型</span>
                <div class="input-group">
                    <div class="input-group-addon">
				       <span style="padding-right: 25px;">
				       	 	<input class="goodsOfType" name="optionsRadios1" value="option3" type="radio"
                                   aria-label="...">现货
				       </span>
                        <span>
				        	<input class="goodsOfType" name="optionsRadios1" value="option4" type="radio"
                                   aria-label="...">订货
				       </span>
                    </div>
                    <div class="input-group-addon"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="detalpric">
        <div class="col-lg-1 col-md-1 col-sm-2 col-xs-12 ">
            <div class="title-content clearfix">
                <span class="title-tag"><i class="must">*</i>详情图</span>
                <span class="subtitle-tag col-sm-12">最多20张</span>
            </div>
        </div>
        <div class="col-md-3 col-sm-4 col-xs-5 imgcontent">
            <a class="thumbnail">
                <button class="upload_button detail_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                <img>
            </a>
        </div>
    </div>
    <!-- 结束详情图 -->
    <div class="row" id="lunbopric">
        <div style="padding-right:0px;" class="col-lg-1 col-md-1 col-sm-2 col-xs-12 ">
            <div class="title-content clearfix">
                <span class="title-tag"><i class="must">*</i>轮播图</span>
                <span class="subtitle-tag col-sm-12">像素800*800</span>
            </div>
        </div>
        <div class="">
            <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
                <a class="thumbnail">
                    <p class="prompt_text">*白底亮灯</p>
                    <button class="upload_button carousel_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                    <img/>
                </a>
            </div>
            <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
                <a class="thumbnail">
                    <p class="prompt_text">*白底不亮灯</p>
                    <button class="upload_button carousel_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                    <img/>
                </a>
            </div>
            <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
                <a class="thumbnail">
                    <p class="prompt_text">*搭配主图，实景图</p>
                    <button class="upload_button carousel_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                    <img/>
                </a>
            </div>
        </div>
    </div>
    <!-- 结束轮播图 -->
    <div class="row" id="mustpric">
        <div style="padding-right:0px;" class="col-lg-1 col-md-1 col-sm-2 col-xs-12 ">
            <div class="title-content clearfix">
                <span class="title-tag"><i class="must">*</i>配灯图</span>
                <span class="subtitle-tag col-sm-12">像素800*800(png格式)</span>
            </div>
        </div>
        <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
            <a class="thumbnail">
                <button class="upload_button lightingChoice"><i class="glyphicon glyphicon-plus "></i>点击上传</button>
                <img/>
            </a>
        </div>
        <div style="padding-right:0px;" class="col-lg-1 col-md-1 col-sm-2 col-xs-12 ">
            <div class="title-content clearfix">
                <span class="title-tag">每日推广</span>
            </div>
        </div>
        <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
            <a class="thumbnail">
                <button class="upload_button dailyPromotion"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                <img/>
            </a>
        </div>
        <div style="padding-right:0px;" class="col-lg-1 col-md-1 col-sm-2 col-xs-12 ">
            <div class="title-content clearfix">
                <span class="title-tag">认证</span>
            </div>
        </div>
        <div class="col-md-3 col-sm-4 col-xs-6 imgcontent">
            <a class="thumbnail">
                <button class="upload_button authentication"><i class="glyphicon glyphicon-plus"></i>点击上传</button>
                <img/>
            </a>
        </div>
    </div>
    <!-- 结束配灯图 -->
    <!-- 输入框开始-->
    <div class="row ">
        <div class="col-md-6 typeList">
            <div class="col-md-12">
                <div class="title-content clearfix">
                    <span class="title-tag"><i class="must">*</i>基本参数</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>类型</span>
                    <select onchange="menuChoice(this)" data-id="37"
                            class="selectpicker form-control productType selectType" data-live-search="true"></select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>价格</span>
                    <input type="number" class="originUnitPrice form-control Price" placeholder="请输入价格"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>风格</span>
                    <select onchange="menuChoice(this)" data-id="39"
                            class="selectpicker form-control style productStyle" data-live-search="true"></select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>交货期</span>
                    <input type="number" class="deliveryTime form-control delivery" placeholder="请输入交货期	"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>光源类型</span>
                    <select onchange="menuChoice(this)" data-id="55" class="lightType selectpicker form-control"
                            data-live-search="true"></select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>光源数量</span>
                    <input type="number" class="lightNumber form-control" placeholder="请输入光源数量"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>光源配送</span>
                    <div class="input-group">
                        <div class="input-group-addon">
				       <span style="padding-right: 25px;">
				       	 	<input class="LightDistribution" name="optionsRadios" value="option1" type="radio"
                                   aria-label="...">是
				       </span>
                            <span>
				        	<input class="LightDistribution" name="optionsRadios" value="option2" type="radio"
                                   aria-label="...">否
				       </span>
                        </div>
                        <div class="input-group-addon"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>库存量</span>
                    <input type="number" class="productStock form-control stock" placeholder="请输入库存量"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon">功率(w)</span>
                    <input type="text" class="productPower form-control" placeholder="请输入功率"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>保质期</span>
                    <input type="text" class="qualityGuaranteeTime form-control" placeholder="请输入时间(例:12月)"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>层</span>
                    <input type="number" class="productPlies form-control" placeholder="请输入层"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon">颜色</span>
                    <input type="text" class="productColor form-control" placeholder="请输入颜色"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon">净重(kg)</span>
                    <input type="text" class="productWeight form-control" placeholder="请输入净重"
                           aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-addon"><i class="must">*</i>形状</span>
                    <select onchange="menuChoice(this)" data-id="54" class="selectpicker form-control productShape"
                            data-live-search="true"></select>
                </div>
            </div>
        </div>
        <div class="col-md-6 materialCheckBox">
            <div class="col-md-12">
                <div class="title-content clearfix">
                    <span class="title-tag"><i class="must">*</i>主体材质</span>
                </div>
            </div>

        </div>
    </div>
    <!-- 输入框结束 -->
    <div class="row">
        <!-- 产品尺寸开始 -->
        <div class="col-md-6 typeList">
            <div class="col-md-12">
                <div class="title-content clearfix">
                    <span class="title-tag"><i class="must">*</i>产品尺寸</span>
                    <span class="subtitle-tag col-sm-12">(填写最少两项)</span>
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">长(cm)</span>
                    <input type="number" class="productLength form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">宽(cm)</span>
                    <input type="number" class="productWidth form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">高(cm)</span>
                    <input type="number" class="productHeight form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">直径(cm)</span>
                    <input type="number" class="productDiameter form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">离墙距离(cm)</span>
                    <input type="number" class="productFromthewall form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <!-- 产品尺寸结束 -->
            <!-- 包装尺寸开始 -->
            <div class="col-md-12">
                <div class="title-content clearfix">
                    <span class="title-tag">包装尺寸</span>
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">长(cm)</span>
                    <input type="number" class="packageLength form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">宽(cm)</span>
                    <input type="number" class="packageWidth form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">高(cm)</span>
                    <input type="number" class="packageHeight form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="col-md-6 ">
                <div class="input-group">
                    <span class="input-group-addon">毛重(kg)</span>
                    <input type="number" class="packageWeight form-control" aria-describedby="basic-addon1">
                </div>
            </div>
            <!-- 包装尺寸结束 -->
        </div>
        <!-- 空间开始 -->
        <div class="col-md-6 spaceCheckBox">
            <div class="col-md-12">
                <div class="title-content clearfix">
                    <span class="title-tag"><i class="must">*</i>空间</span>
                </div>
            </div>

        </div>
        <!-- 空间结束 -->
        <!-- 底部提交按钮 -->
        <div class="container-fluid" style="height:0px;">
            <button id="subtim_btn" type="button" class="btn-lg btn btn-success pull-right">
                保存
            </button>
        </div>
        <!-- 底部提交按钮 -->
    </div>
</div>
<input class="upload" id="file" accept="image/*" type="file" style="display: none"/>
</body>
<script type="text/javascript">
    $(init());

    //初始化页面
    function init() {
        $(document).off("click");
        //初始化输入框
        for (var index in curRow) {
            var dom = $("." + index);
            if (dom != undefined) {
                dom.val(curRow[index]);
            }
        }
        //初始化系列
        $.ajax({
            url: "/admin/api/select/productSeries",
            data: {
                userId: 0
            },
            dataType: "json",
            type: "get",
            success: function (json) {
                var txt;
                for (var i = 0; i < json.length; i++) {
                    txt += '<option value="' + json[i].id + '" selected="selected">' + json[i].seriesName + '系列</option>';
                }
                document.getElementById('series').innerHTML = txt;
                if (curRow.productSeries != undefined)
                    $('#series').val(curRow.productSeries.seriesName);
            },
            error: function () {
                console.log("初始化产品系列失败!");
            }
        });
        /**
         * 初始化空间和材质
         */
        initCheckBox($(".materialCheckBox"), 38, "material");
        initCheckBox($(".spaceCheckBox"), 40, "space");
        //初始化货型
        if (curRow.productKind == 1) {
            $(".goodsOfType").eq(0).prop('checked', true);
        } else {
            $(".goodsOfType").eq(1).prop('checked', true);
        }
        //初始化所有下拉选框
        var selects = $(".selectpicker");
        var arr = new Array();
        for (var i = 1; i < selects.length; i++) {
            if ($(selects[i]).attr("data-id") != undefined) arr[arr.length] = $(selects[i]).attr("data-id");
        }
        //初始化材质空间
        $.ajax({
            url: "/api/propertyValue",
            data: {
                "haveProduct": 1,
                "ids": arr
            },
            dataType: "json",
            type: "get",
            success: function (json) {
                for (var i = 1; i < $(".selectpicker").length; i++) {
                    var select = $(".selectpicker").eq(i);
                    var value = select.attr("data-id");
                    for (var o = 0; o < json.length; o++) {
                        if (json[o].propertyId == value)
                            select.append('<option value="' + json[o].propertyValueId + '">' + json[o].propertyValue + '</option>');
                    }
                    if (i == 3) select.val(curRow.productType);
                    if (i == 4) select.val(curRow.productStyle);
                    if (i == 5) select.val(curRow.lightType);
                    if (i == 6) select.val(curRow.productShape);
                }
            },
            error: function () {
                console.log("获取产品属性失败!");
            }
        });
        //初始化是否配灯
        if (curRow.hasLightSource == 1) {
            $(".LightDistribution").eq(0).prop('checked', true);
            menuChoice($(".lightType"));
        } else {
            $(".LightDistribution").eq(1).prop('checked', true);
        }

        /**
         * 初始化图片
         */
        var arrImg = curRow.descriptionPic.split(',');

        for (var i = 0; i < arrImg.length; i++) {
            $(".detail_map").eq(i).parent().parent().before('<div class="asd col-md-3 col-sm-4 col-xs-5 imgcontent"><i class="glyphicon glyphicon-remove"></i><a class="thumbnail"><button class="upload_button detail_map" style="display:none;"><i class="glyphicon glyphicon-plus"></i>点击上传</button><img src="' + arrImg[i] + '"></a></div>');
        }
        if (arrImg.length >= 20) {
            $(".detail_map").eq(20).parent().parent().remove();
        }

        //初始化轮播图
        var arrCarousel = curRow.cover.split(',');
        var carousel_map = $(".carousel_map");
        for (var i in arrCarousel) {
            carousel_map.eq(i).next().attr("src", arrCarousel[i]);
            carousel_map.eq(i).parent().before('<i class="glyphicon glyphicon-remove"></i>');
            carousel_map.eq(i).css("display", "none");
            carousel_map.eq(i).prev().css("display", "none");
        }

        if (curRow.productPngPic != undefined && curRow.productPngPic.length != 0) {
            $(".lightingChoice").next().attr("src", curRow.productPngPic).prev().css("display", "none");
            $(".lightingChoice").parent().before('<i class="glyphicon glyphicon-remove"></i>');
        }
        if (curRow.productSpreadPic != undefined && curRow.productSpreadPic.length != 0) {
            $(".dailyPromotion").next().attr("src", curRow.productSpreadPic).prev().css("display", "none");
            $(".dailyPromotion").parent().before('<i class="glyphicon glyphicon-remove"></i>');
        }
        if (curRow.threeCCertification != undefined && curRow.threeCCertification.length != 0) {
            $(".authentication").next().attr("src", curRow.threeCCertification).prev().css("display", "none");
            $(".authentication").parent().before('<i class="glyphicon glyphicon-remove"></i>');
        }
    }

    /**
     * 选择框选择功能
     */
    function menuChoice(obj) {
        var str = $(obj).html();
        //特殊要求:当选择自带LED时光源必须配送功率必须填写
        if ($(obj).val() == 619) {
            str += "(必配光源)"
            $(".LightDistribution").eq(0).prop('checked', true);//选中光源配送
            $(".LightDistribution").eq(0).attr("disabled", "disabled");
            $(".LightDistribution").eq(1).attr("disabled", "disabled");
            $(".power").prev().html('<i class="must">*</i>' + $(".power").prev().html());
        } else {
            $(".LightDistribution").eq(0).removeAttr("disabled", "disabled");
            $(".LightDistribution").eq(1).removeAttr("disabled", "disabled");
            $(".power").prev().find("i").remove();
        }
    }

    /**
     * 检查产品尺寸输入是否正确(最少输入两样)
     */
    function productSizeCheck(input) {
        var fillInLength = 0;//产品尺寸填写数量
        if ($(".productLength").val() != "") fillInLength++;//长度
        if ($(".productWidth").val() != "") fillInLength++;//宽度
        if ($(".productHeight").val() != "") fillInLength++;//高度
        if ($(".productDiameter").val() != "") fillInLength++;//直径
        if ($(".productFromthewall").val() != "") fillInLength++;//离墙距离
        if (fillInLength < 2) return false;
        return true;
    }

    /**
     * 提交按钮
     */
    $(document).on("click", "#subtim_btn", function () {
        var ajaxData = checkInput();
        if (ajaxData) {
            $.confirm({
                title: "提示",
                content: "确认提交?",
                confirmButtonClass: 'btn-info',
                cancelButtonClass: 'btn-danger',
                confirmButton: "立即提交",
                cancelButton: '取消',
                onAction: function (action) {
                    if (action == "confirm") {
                        $.ajax({
                            url: "/admin/api/product",
                            dataType: "json",
                            type: "post",
                            data: ajaxData,
                            success: function (json) {
                                if (json.code == 1) {
                                    //提交成功,开始上传图片
                                    uploadProductPic(json.entity.productId);
                                }
                            },
                            error: function (data) {
                                showMsg("提示", "保存产品错误!");
                            }
                        });
                    }
                }
            })
        }
    });

    /**
     * 初始化空间和材质checkBox选项
     */
    function initCheckBox(obj, propertyValue, attribute) {
        $.ajax({
            url: "/api/propertyValue",
            data: {
                "haveProduct": 1,
                "ids": [propertyValue]
            },
            dataType: "json",
            type: "get",
            success: function (json) {
                if (obj.find("div").length > 2) return;
                for (var i in json) {
                    if (attribute == "space" && curRow.productSpace.indexOf(json[i].propertyValueId) > -1) {
                        obj.append('<div class="col-md-4 col-xs-6"><div class="input-group ' + attribute + '" ><span class="input-group-addon checkbox addonColor" data-id="' + json[i].propertyValueId + '"><input type="checkbox" aria-label="..."><i class="glyphicon glyphicon-ok"></i></span><input style="font-size:14px;padding: 0px;padding-left:5px" type="text" value="' + json[i].propertyValue + '" class="form-control" aria-label="..." disabled="disabled"></div></div>');
                        spaceCount++;

                    } else if (attribute == "material" && curRow.productMaterial.indexOf(json[i].propertyValueId) > -1) {
                        obj.append('<div class="col-md-4 col-xs-6"><div class="input-group ' + attribute + '" ><span class="input-group-addon checkbox addonColor" data-id="' + json[i].propertyValueId + '"><input type="checkbox" aria-label="..."><i class="glyphicon glyphicon-ok"></i></span><input style="font-size:14px;padding: 0px;padding-left:5px" type="text" value="' + json[i].propertyValue + '" class="form-control" aria-label="..." disabled="disabled"></div></div>');
                        materialCount++;
                    } else {
                        obj.append('<div class="col-md-4 col-xs-6"><div class="input-group ' + attribute + '" ><span class="input-group-addon checkbox" data-id="' + json[i].propertyValueId + '"><input type="checkbox" aria-label="..."><i class="glyphicon glyphicon-ok"></i></span><input style="font-size:14px;padding: 0px;padding-left:5px" type="text" value="' + json[i].propertyValue + '" class="form-control" aria-label="..." disabled="disabled"></div></div>');
                    }
                }
            },
            error: function () {
                console.log("获取用户角色失败!");
            }
        });
    }

    /**
     * 切换空间和材质的checkbox选择状态
     */
    var spaceCount = 0;//选中空间数
    var materialCount = 0;//选中材质数
    var materialSize = 3; //最大材质选择数
    var spaceSize = 3;//最大空间选择数
    $(document).on("click", ".checkbox", function () {
        var span = $(this).toggleClass("addonColor")[0];
        //特殊要求空间和材质每项最多选3个
        if ($(span).hasClass("addonColor")) {
            if ($(span).parent().hasClass("material")) {
                materialCount++;
            } else {
                spaceCount++;
            }
        } else {
            if ($(span).parent().hasClass("material")) {
                materialCount--;
            } else {
                spaceCount--;
            }
        }
        if (materialCount > materialSize) {
            $(this).toggleClass("addonColor");
            materialCount--;
            showMsg("提示", "宝贝材质最多只能" + materialCount + "种");
        }
        if (spaceCount > spaceSize) {
            $(this).toggleClass("addonColor");
            spaceCount--;
            showMsg("提示", "宝贝使用空间最多只能" + spaceCount + "种");
        }
    });

    /**
     * 监听详情图图片上传按钮点击事件
     */
    $(document).on("click", ".upload_button", function () {
        $("#file").click();//触发选择文件
        var img = $(this).next();//图片标签
        var btn = $(this);//按钮
        var detail_map_box = $(this).parent().parent();
        $("#file").off("change").on("change", function () {//解决事件多次绑定
            //限制图片上传类型
            if (btn.hasClass("detail_map")) {
                var allowtype = ["jpg", "png", "Jpeg"];
            } else if (btn.next().hasClass("lightingChoice")) {
                var allowtype = ["png"];
            } else {
                var allowtype = ["jpg", "png", "Jpeg"];
            }
            //详情图最大数量
            var maxdis = 20;
            //渲染图片
            if (imgReader($(this), img, allowtype)) {
                btn.css("display", "none");
                if (btn.hasClass("detail_map") && $(".detail_map").length < maxdis)//上传的是详情图
                    detail_map_box.after('<div class="col-md-3 col-sm-4 col-xs-5 imgcontent"><a class="thumbnail"><button class="upload_button detail_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button><img></a></div>');
                if (btn.hasClass("carousel_map"))//上传的是轮播图
                    btn.prev().css("display", "none");
            }
        });
    });

    /**
     * 删除图片DOM方法
     */
    $(document).on("click", ".glyphicon-remove", function () {
        if ($(this).next().find("button").hasClass("carousel_map")) {
            $(this).next().find("button").next().remove();
            $(this).next().find("button").parent().append('<img>');
            $(this).next().find("button").css("display", "block");
            $(this).next().find("p").css("display", "block");
            $(this).remove();
            return;
        }
        if ($(this).next().find("button").hasClass("lightingChoice")) {
            $(this).next().find("button").next().remove();
            $(this).next().find("button").parent().append('<img>');
            $(this).next().find("button").css("display", "block");
            $(this).remove();
            return;
        }
        if ($(this).next().find("button").hasClass("dailyPromotion")) {
            $(this).next().find("button").next().remove();
            $(this).next().find("button").parent().append('<img>');
            $(this).next().find("button").css("display", "block");
            $(this).remove();
            return;
        }
        if ($(this).next().find("button").hasClass("authentication")) {
            $(this).next().find("button").next().remove();
            $(this).next().find("button").parent().append('<img>');
            $(this).next().find("button").css("display", "block");
            $(this).remove();
            return;
        }
        $(this).parent().remove();
        if ($(".detail_map").length < 20 && $(".detail_map").eq($(".detail_map").length - 1).next().attr("src") != undefined) {
            var detail_map_box = $(".detail_map").eq($(".detail_map").length - 1).parent().parent();
            detail_map_box.after('<div class="col-md-3 col-sm-4 col-xs-5 imgcontent"><a class="thumbnail"><button class="upload_button detail_map"><i class="glyphicon glyphicon-plus"></i>点击上传</button><img></a></div>');
        }
    });

    /**
     * 图片渲染方法
     * @param {Object} 文件input元素
     * @param {Object} 需要渲染的img元素
     * @param {Object} 允许的文件类型 如[ "jpg", "gif","png","Jpeg"]
     */
    function imgReader(file_input, img, allowtype) {
        file_input[0].outerHTML = file_input[0].outerHTML;//清空文件路径
        var file = file_input[0].files[0];
        if (file == undefined) return false;//如果文件为空不处理
        var fileSize = file.size;
        var size = fileSize / 1024 / 1024;//获取文件大小
        if (size > 1) {
            $.confirm({
                title: "警告",
                content: '文件不能大于1M!',
                cancelButton: false,
                confirmButton: false,
                confirmButton: "OK",
                backgroundDismiss: true,
                closeIcon: false
            });
            return false;
        } else {
            //校验文件类型
            if (!checkfiletype(file_input[0].value, allowtype)) {
                $.confirm({
                    title: "警告",
                    content: '请上传正确文件类型' + allowtype,
                    cancelButton: false,
                    confirmButton: false,
                    backgroundDismiss: true,
                    closeIcon: false
                });
                return false;//判断文件类型
            }
        }
        //渲染img标签
        var fileReader = new FileReader();
        fileReader.onloadend = function () {
            if (fileReader.readyState == fileReader.DONE) {
                img.attr('src', fileReader.result);
                img.parent().before('<i class="glyphicon glyphicon-remove"></i>');
            }
        };
        fileReader.readAsDataURL(file);
        return true;
    }

    /**
     * 验证文件类型
     * @param {Object} filepath 获取到的文件路径
     * @param {Object} allowtype 允许通过的文件类型数组如 图片： [ "jpg", "gif","png","Jpeg"]
     */
    function checkfiletype(filepath, allowtype) {
        //截取文件后缀名
        var thisfiletype = filepath.substring(filepath.lastIndexOf(".") + 1, filepath.length).toLowerCase();
        if ($.inArray(thisfiletype, allowtype) == -1) {
            return false;
        } else {
            return true;
        }
    }
</script>
</html>